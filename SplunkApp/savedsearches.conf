[User added to privileged group by non-admin account]
action.create_alert = 1
action.create_alert.param.template = 672e7424c8f5d6b70e077649
action.create_alert.param.title = User added to privileged group by non-admin account
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=4728 OR EventCode=4732 OR EventCode=4756 \
| search NOT Account_Name IN ("frank", "olivia", "alice", "yara", "david", "katherine", "uma", "SRV-PRD-DC$", "SRV-PRD-WEB$", "SRV-PRD-DB$", "SRV-PRD-SHARE$")\
| stats count by host, source, sourcetype, Account_Name, Account_Domain, member_dn, member_nt_domain, ComputerName, timestamp \
| eval alert="User added to privileged group by non-admin account"

[Privilege escalation attempt by non-admin user with SYSTEM token]
action.create_alert = 1
action.create_alert.param.template = 672e7424c8f5d6b70e077649
action.create_alert.param.title = Privilege escalation attempt by non-admin user with SYSTEM token
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : Cette règle identifie les tentatives d’usurpation de jetons NT AUTHORITY\SYSTEM par des comptes standards, qui peuvent être utilisées pour élever les privilèges. Cela donne un accès critique au système et peut être exploitée pour contourner les contrôles de sécurité.\
\
Remédiation : Limiter les permissions d’usurpation de jeton aux comptes de confiance et renforcer la détection d'accès non autorisés via des outils de surveillance.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=4672 Account_Name="NT AUTHORITY\\SYSTEM"\
| search NOT Account_Name IN ("frank", "olivia", "alice", "yara", "david", "katherine", "uma", "SRV-PRD-DC$", "SRV-PRD-WEB$", "SRV-PRD-DB$", "SRV-PRD-SHARE$")\
| stats count by host, source, sourcetype, Account_Name, ComputerName, subject, dest_nt_domain, Privileges, timestamp \
| eval alert="Privilege escalation attempt by non-admin user with SYSTEM token"

[Privilege escalation attempt with Runas by non-admin user]
action.create_alert = 1
action.create_alert.param.template = 672e7424c8f5d6b70e077649
action.create_alert.param.title = Privilege escalation attempt with Runas by non-admin user
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : Cette règle détecte l’utilisation de Runas, un outil permettant l’exécution de commandes avec des privilèges élevés. Les utilisateurs non administratifs tentant de lancer des processus Runas peuvent indiquer des tentatives d’escalade.\
\
Remédiation : Restreindre les droits d’exécution de Runas et surveiller régulièrement les processus en cours pour identifier des activités suspectes.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=4648 \
| search Process_Name="*runas*" NOT Account_Name IN ("frank", "olivia", "alice", "yara", "david", "katherine", "uma", "SRV-PRD-DC$", "SRV-PRD-WEB$", "SRV-PRD-DB$", "SRV-PRD-SHARE$")\
| stats count by host, source, sourcetype, Account_Name, ComputerName, Process_Name, timestamp \
| eval alert="Privilege escalation attempt with Runas by non-admin user"

[Potential privilege escalation via PowerShell by non-admin user]
action.create_alert = 1
action.create_alert.param.template = 672e7424c8f5d6b70e077649
action.create_alert.param.title = Potential privilege escalation via PowerShell by non-admin user
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : PowerShell est souvent utilisé pour exécuter des scripts avec des privilèges élevés. La détection de commandes suspectes (`Bypass`) par des comptes standards indique une potentielle tentative d’abuser de PowerShell pour élever les privilèges.\
\
Remédiation : Restreindre les autorisations PowerShell aux comptes de confiance et utiliser des politiques de contrôle d’application pour limiter les scripts non autorisés.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=4688 New_Process_Name="*powershell.exe" CommandLine="*Bypass*"\
| search NOT Account_Name IN ("frank", "olivia", "alice", "yara", "david", "katherine", "uma", "SRV-PRD-DC$", "SRV-PRD-WEB$", "SRV-PRD-DB$", "SRV-PRD-SHARE$")\
| stats count by host, source, sourcetype, Account_Name, ComputerName, Process_Command_Line, timestamp \
| eval alert="Potential privilege escalation via PowerShell by non-admin user"

[Potential privilege escalation via new service creation by non-admin]
action.create_alert = 1
action.create_alert.param.template = 672e7424c8f5d6b70e077649
action.create_alert.param.title = Potential privilege escalation via new service creation by non-admin
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : Cette règle détecte la création de nouveaux services système, une technique courante pour obtenir un accès persistant avec des privilèges élevés.\
\
Remédiation : Restreindre la création de services aux comptes administratifs et surveiller les nouveaux services pour éviter toute persistance malveillante.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=4697\
| search NOT Account_Name IN ("frank", "olivia", "alice", "yara", "david", "katherine", "uma", "SRV-PRD-DC$", "SRV-PRD-WEB$", "SRV-PRD-DB$", "SRV-PRD-SHARE$")\
| stats count by host, source, sourcetype, Account_Name, ComputerName, timestamp \
| eval alert="Potential privilege escalation via new service creation by non-admin"

[Suspicious access attempt to SAM database]
action.create_alert = 1
action.create_alert.param.template = 672e7424c8f5d6b70e077649
action.create_alert.param.title = Suspicious access attempt to SAM database
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : Le fichier SAM contient des informations sensibles sur les comptes et est ciblé dans des tentatives de vol de crédentiels. Un accès non autorisé peut indiquer une tentative de compromission de compte.\
\
Remédiation : Limiter l'accès aux fichiers SAM et activer des politiques de sécurité pour prévenir l'accès non autorisé.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=4663 Object_Name="*\\sam"\
| search NOT Account_Name IN ("frank", "olivia", "alice", "yara", "david", "katherine", "uma", "SRV-PRD-DC$", "SRV-PRD-WEB$", "SRV-PRD-DB$", "SRV-PRD-SHARE$")\
| stats count by host, source, sourcetype, Account_Name, ComputerName, Object_Name, Accesses, timestamp \
| eval alert="Suspicious access attempt to SAM database"

[Potential Golden Ticket attack detected]
action.create_alert = 1
action.create_alert.param.template = 672e7424c8f5d6b70e077649
action.create_alert.param.title = Potential Golden Ticket attack detected
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : Les attaques de type Golden Ticket exploitent les tickets Kerberos pour un accès prolongé aux ressources avec des privilèges élevés. Un ticket avec des options inhabituelles peut indiquer une manipulation pour obtenir des droits d'accès non autorisés.\
\
Remédiation : Activer la journalisation et la surveillance Kerberos, et restreindre l'accès aux comptes Kerberos TGT pour protéger les tickets.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=4768\
| where Ticket_Options="0x40810000"\
| search NOT Account_Name IN ("frank", "olivia", "alice", "yara", "david", "katherine", "uma", "SRV-PRD-DC$", "SRV-PRD-WEB$", "SRV-PRD-DB$", "SRV-PRD-SHARE$")\
| stats count by host, source, sourcetype, Account_Name, ComputerName, Ticket_Options, timestamp \
| eval alert="Potential Golden Ticket attack detected"

[Unauthorized RDP connection detected]
action.create_alert = 1
action.create_alert.param.template = 672e7873c8f5d6b70e07764c
action.create_alert.param.title = Unauthorized RDP connection detected
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : Cette règle détecte des connexions RDP (Remote Desktop Protocol) initiées par des comptes non autorisés, indiquant potentiellement un mouvement latéral d'un attaquant.\
\
Remédiation : Restreindre l'accès RDP aux comptes autorisés uniquement et activer la journalisation des connexions.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=4624 Logon_Type=10\
| search NOT Account_Name IN ("frank", "olivia", "alice", "yara", "david", "katherine", "uma", "SRV-PRD-DC$", "SRV-PRD-WEB$", "SRV-PRD-DB$", "SRV-PRD-SHARE$")\
| stats count by host, source, sourcetype, Account_Name, ComputerName, timestamp \
| eval alert="Unauthorized RDP connection detected"

[Suspicious internal IP scanning using net.exe]
action.create_alert = 1
action.create_alert.param.template = 672e7873c8f5d6b70e07764c
action.create_alert.param.title = Suspicious internal IP scanning using net.exe
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : Cette règle identifie l'utilisation de la commande `net view` pour découvrir des adresses IP et des ressources partagées sur le réseau, indiquant une possible reconnaissance en préparation d'un mouvement latéral.\
\
Remédiation : Restreindre l'accès à la commande `net.exe` aux comptes autorisés et surveiller les commandes de reconnaissance.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=5145\
| search Process_Command_Line="*net view*" Object_Type="File" Object_Name="*\system32\net.exe*"\
| stats count by host, source, sourcetype, Account_Name, ComputerName, timestamp \
| eval alert="Suspicious internal IP scanning using net.exe"

[Unauthorized PsExec usage detected]
action.create_alert = 1
action.create_alert.param.template = 672e7873c8f5d6b70e07764c
action.create_alert.param.title = Unauthorized PsExec usage detected
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : PsExec est un outil utilisé pour exécuter des processus sur d'autres machines. L'utilisation par des comptes non administratifs pourrait indiquer un mouvement latéral pour exécuter des commandes à distance.\
\
Remédiation : Limiter l'accès à PsExec aux comptes administratifs et surveiller l'utilisation des outils d'administration à distance.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=7045 Service_Name="*PSEXESVC*"\
| search NOT Account_Name IN ("frank", "olivia", "alice", "yara", "david", "katherine", "uma", "SRV-PRD-DC$", "SRV-PRD-WEB$", "SRV-PRD-DB$", "SRV-PRD-SHARE$")\
| stats count by host, source, sourcetype, Account_Name, ComputerName, timestamp \
| eval alert="Unauthorized PsExec usage detected"

[Suspicious tool copied to network share]
action.create_alert = 1
action.create_alert.param.template = 672e7873c8f5d6b70e07764c
action.create_alert.param.title = Suspicious tool copied to network share
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : Cette règle détecte la copie d'outils suspects vers des partages réseau, souvent utilisée par les attaquants pour préparer le mouvement latéral.\
\
Remédiation : Restreindre l'accès aux partages réseau et surveiller les activités inhabituelles sur les répertoires partagés.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=5145 Object_Type="File" \
| search Object_Name="*\\tools\\*" NOT Account_Name IN ("frank", "olivia", "alice", "yara", "david", "katherine", "uma", "SRV-PRD-DC$", "SRV-PRD-WEB$", "SRV-PRD-DB$", "SRV-PRD-SHARE$")\
| stats count by host, source, sourcetype, Account_Name, ComputerName, Object_Name, timestamp \
| eval alert="Suspicious tool copied to network share"

[Suspicious WMI command execution detected]
action.create_alert = 1
action.create_alert.param.template = 672e7873c8f5d6b70e07764c
action.create_alert.param.title = Suspicious WMI command execution detected
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : WMI est utilisé pour gérer des systèmes à distance. L'exécution de commandes à l'aide de WMI par des utilisateurs non autorisés peut indiquer un mouvement latéral.\
\
Remédiation : Limiter l'accès à WMI aux comptes de confiance uniquement et surveiller les activités WMI.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=4688 New_Process_Name="*wmic.exe"\
| search Process_Command_Line="*process call create*"\
| stats count by host, source, sourcetype, Account_Name, ComputerName, timestamp \
| eval alert="Suspicious WMI command execution detected"

[Unauthorized network share access detected]
action.create_alert = 1
action.create_alert.param.template = 672e7873c8f5d6b70e07764c
action.create_alert.param.title = Unauthorized network share access detected
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : L'accès à des partages réseau peut indiquer une tentative de mouvement latéral pour accéder à des fichiers ou des outils sensibles.\
\
Remédiation : Limiter l'accès aux partages réseau aux utilisateurs autorisés uniquement et surveiller les tentatives d'accès.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=5140 Object_Name="*\\*"\
| search NOT Account_Name IN ("frank", "olivia", "alice", "yara", "david", "katherine", "uma", "SRV-PRD-DC$", "SRV-PRD-WEB$", "SRV-PRD-DB$", "SRV-PRD-SHARE$")\
| stats count by host, source, sourcetype, Account_Name, ComputerName, timestamp \
| eval alert="Unauthorized network share access detected"

[Unauthorized Remote PowerShell session detected]
action.create_alert = 1
action.create_alert.param.template = 672e7873c8f5d6b70e07764c
action.create_alert.param.title = Unauthorized Remote PowerShell session detected
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Explication de l'attaque : L'utilisation de PowerShell pour ouvrir une session à distance (`Enter-PSSession`) peut indiquer une tentative de mouvement latéral vers un autre système.\
\
Remédiation : Restreindre l'utilisation de PowerShell à distance aux comptes administratifs et surveiller les activités PowerShell pour détecter des utilisations non autorisées.
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog EventCode=4104 Process_Command_Line="*Enter-PSSession*"\
| search NOT Account_Name IN ("frank", "olivia", "alice", "yara", "david", "katherine", "uma", "SRV-PRD-DC$", "SRV-PRD-WEB$", "SRV-PRD-DB$", "SRV-PRD-SHARE$")\
| stats count by host, source, sourcetype, Account_Name, ComputerName, timestamp \
| eval alert="Unauthorized Remote PowerShell session detected"

[Defense Evasion Suppression Journaux]
action.create_alert = 1
action.create_alert.param.template = 672f22b5c8f5d6b70e077669
action.create_alert.param.title = Defense Evasion Suppression Journaux
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = */5 * * * *
description = Cette alerte permettra de détecter la suppression de l’historique des journaux de sécurité Windows.
dispatch.earliest_time = -5m
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","EventCode"]
enableSched = 1
quantity = 2
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix source="WinEventLog:Security"\
| search EventCode=1102

[Defense Evasion : windows defender]
action.create_alert = 1
action.create_alert.param.template = 6708f79facb7e736e905a651
action.create_alert.param.title = Defense Evasion Windows Defender
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = */5 * * * *
description = Cette règle permet de détecter des actions potentiellement malveillantes modifiant les paramètres de sécurité de Windows Defender.
dispatch.earliest_time = -5m
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","EventCode"]
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="connectix" \
(\
    (sourcetype="WinEventLog" OR sourcetype="WinEventLog:Microsoft-Windows-Sysmon/Operational") \
    EventCode=4688 \
    (\
        "Set-MpPreference -DisableRealtimeMonitoring $true" \
        OR "Set-MpPreference -DisableBehaviourMonitoring $true"\
        OR "Set-MpPreference -DisableBlockAtFirstSeen $true"\
        OR "Add-MpPreference -ExclusionPath"\
        OR "Get-MpComputerStatus" OR "Add-MpPreference -ExclusionExtension" OR "Add-MpPreference -ExclusionProcess"\
\
    \
    )\
) \
OR \
(\
    sourcetype="WinEventLog:Microsoft-Windows-Powershell/Operational" \
    (\
        "Set-MpPreference -DisableRealtimeMonitoring $true" \
        OR "Set-MpPreference -DisableBehaviourMonitoring $true"\
        OR "Set-MpPreference -DisableBlockAtFirstSeen $true"\
        OR "Add-MpPreference -ExclusionPath"\
        OR "Get-MpComputerStatus" OR "Add-MpPreference -ExclusionExtension" OR "Add-MpPreference -ExclusionProcess"\
\
    \
    )\
)

[Defense Evasion arret ou desactivation de service]
action.create_alert = 1
action.create_alert.param.template = 672f28b6c8f5d6b70e0776b8
action.create_alert.param.title = Defense Evasion arret ou desactivation de service
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = */5 * * * *
description = Elle vise à surveiller les modifications critiques dans l'état des services système, ce qui pourrait indiquer une tentative de contournement de la sécurité (par désactivation ou arrêt des services clés)
dispatch.earliest_time = -5m
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","EventCode"]
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix (source="WinEventLog:System" OR source="WinEventLog:Microsoft-Windows-Security-Mitigations/KernelMode")\
EventCode=7024 OR EventCode=7045 OR EventCode=7036 \
| search "Stopped" OR "Disabled"

[Credential Access recuperation didentifiants]
action.create_alert = 1
action.create_alert.param.template = 672f3238c8f5d6b70e07780a
action.create_alert.param.title = Credential Access recuperation didentifiants
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = */5 * * * *
description = Cette requête permet de détecter des événements où un outil ou une commande liée à Mimikatz ou à l'extraction des informations d'identification est utilisé.
dispatch.earliest_time = -5m
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","EventCode"]
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="connectix" \
(\
    sourcetype="WinEventLog:Microsoft-Windows-Sysmon/Operational" \
    OR sourcetype="sysmon" \
    OR sourcetype="WinEventLog" \
) \
(EventCode=1 OR EventCode=4672)  // EventCode=1 pour la création de processus, 4672 pour l’attribution de privilèges\
(\
    "sekurlsa::logonpasswords" \
    OR "Mimikatz" \
    OR "NTLM" \
    OR "LSASS" \
    OR "logonpasswords" \
    OR "dump" \
    OR "msv1_0" \
    OR "kerberos" \
    OR "NTDS" \
    OR "LsaDumper" \
    OR "Invoke-Mimikatz"\
    OR "privilege::debug"\
)

[Exfiltration Over Web Service]
action.create_alert = 1
action.create_alert.param.template = 672eb078c8f5d6b70e077661
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 15 * * * *
description = Surveiller les connexions HTTP/HTTPS sortantes avec l'envoi des données
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="connectix" sourcetype="suricata"((dest_port IN (80, 443) OR src_port IN (80, 443)) AND  (src_host IN ("SRV-PRD-SHARE", "SRV-PRD-DB"))) (method="POST")\
    AND\
    (bytes > 0)

[Exfiltration Over Command and Control Channel]
action.create_alert = 1
action.create_alert.param.template = 672ead3dc8f5d6b70e07765d
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 15 * * * *
description = Canal de commande et de contrôle établi pour exfiltrer des données en même temps de la  communication avec l'infrastructure
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 4
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="connectix" sourcetype="suricata"\
(\
	(dest_port IN (53, 80, 443, 8080, 8443, 21, 22, 25) OR src_port IN (53, 80, 443, 8080, 8443, 21, 22, 25))\
	AND\
	(src_ip IN ("192.168.10.23", "192.168.10.22", "192.168.10.21", "192.168.10.10")\
	AND dest_ip IN ("199.232.214.172", "185.220.101.0", "185.220.101.25", "104.248.44.25", "185.53.179.74","1.1.1.1"))\
	AND (bytes > 50000)\
)\
| table _time, src_ip, dest_ip, src_port, dest_port, protocol, event_type

[Network Share Discovery]
action.create_alert = 1
action.create_alert.param.template = 672fb9aac8f5d6b70e077ad3
action.create_alert.param.title = Network Share Discovery
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 15 * * * *
description = Reconnaissance d' une attaque, visant à collecter des informations ou à préparer l’accès à des ressources internes
dispatch.earliest_time = -7d@h
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="connectix"\
(sourcetype="WinEventLog"\
 OR sourcetype="suricata"\
 OR sourcetype="WinEventLog:Microsoft-Windows-Sysmon/Operational"\
 OR sourcetype="WinEventLog:Microsoft-Windows-Powershell/Operational")\
 EventCode=5140 OR EventCode=5142 OR EventCode=5143 OR EventCode=5144\
| where Accesses="ReadData (or ListDirectory)"\
| where NOT cidrmatch("192.168.10.0/24", src_ip)\
| where user!="SYSTEM" AND user!="LOCAL SERVICE" AND user!="NETWORK SERVICE"\
| table _time src_ip src_port user Share_Name Accesses\
| sort -_time

[Browser Session Hijacking]
action.create_alert = 1
action.create_alert.param.template = 672fc6ccc8f5d6b70e077c27
action.create_alert.param.title = Browser Session Hijacking
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 15 * * * *
description = Surveiller les tentatives de vol de session
dispatch.earliest_time = -1h
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","http.request_headers{}.name","http.response_headers{}.value","http.request_headers{}.value","http.response_headers{}.name"]
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="connectix" sourcetype=suricata \
(http.request_headers{}.name="Cookie" OR http.request_headers{}.name="Authorization" OR http.request_headers{}.name="Set-Cookie")\
    AND (http.request_headers{}.value="Bearer*" OR http.request_headers{}.value="*session_id*")

[Exfiltration via Removable Media]
action.create_alert = 1
action.create_alert.param.template = 672e9a3fc8f5d6b70e07765a
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 15 * * * *
description = Utilisation d'un support amovible pour transférer les données manuellement
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="connectix" EventCode=4663 eventtype=wineventlog_windows name="An attempt was made to access an object" (Process_Name="C:\\Windows\\explorer.exe" OR Process_Name="C:\\Windows\\System32\\cmd.exe" OR Process_Name="C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe" OR Process_Name="C:\\Windows\\System32\\robocopy.exe") (Accesses="WriteData (or AddFile)" OR Accesses="ReadData (or ListDirectory)") | table _time, host, ComputerName, EventCode, Account_Name, ObjectName, Accesses, Process_Name

[Suspicious Use of WinRM on Port 5985]
action.create_alert = 1
action.create_alert.param.template = 6730b1cbc8f5d6b70e077f7e
action.create_alert.param.title = Suspicious Use of WinRM on Port 5985
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Detect potentially unauthorized use of WinRM (Windows Remote Management) over port 5985
dispatch.earliest_time = -1h
dispatch.latest_time = now
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype="WinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=3\
| search DestinationPort=5985 (Image="*powershell.exe*" OR Image="*svchost.exe*") Sid="S-1-5-18"\
| stats count by Image, DestinationIp, DestinationPort, SourceIp, Sid, ComputerName\
| where count > 5\
| table Image, DestinationIp, DestinationPort, SourceIp, Sid, ComputerName, count

[Detect Outbound Connections on Unusual Ports]
action.create_alert = 1
action.create_alert.param.template = 6730c89ec8f5d6b70e077fa0
action.create_alert.param.title = Detect Outbound Connections on Unusual Ports
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Potential C2 Communication via Non-Standard Port
dispatch.earliest_time = -1h
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","query"]
display.general.type = statistics
display.page.search.mode = verbose
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype="suricata"\
| search NOT dest_port IN (80, 443, 53)\
| stats count by src_ip, dest_ip\
| table src_ip, dest_ip, count

[Unsuccessful Logon Attempts]
action.create_alert = 1
action.create_alert.param.template = 672f23aec8f5d6b70e07766d
action.create_alert.param.title = Unsuccessful Logon Attempts
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.suppress.fields = Account_Name
alert.suppress.period = 60s
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
description = Alerts when an unsuccessful logon attempt is detected, indicating a potential unauthorized access or attack.
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
display.events.fields = ["source","sourcetype"]
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix source="WinEventLog:Security" EventCode="4625"\
| eval Host=coalesce(Host, Source_Network_Address)\
| table _time, Host, Account_Name, Logon_Type, Failure_Reason\
| sort - _time

[Detect DNS Tunneling]
action.create_alert = 1
action.create_alert.param.template = 6730c89ec8f5d6b70e077fa0
action.create_alert.param.title = Detect DNS Tunneling
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 0 * * * *
dispatch.earliest_time = -1h
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","query"]
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=suricata\
| search app_proto="dns" AND dest_ip="*" \
| stats count by host, src_ip, dest_ip\
| table host, src_ip, dest_ip, count

[Ajout des utilisateurs ou des groupes]
action.create_alert = 1
action.create_alert.param.template = 6730d284c8f5d6b70e077fb7
action.create_alert.param.title = Ajout des utilisateurs ou des groupes
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = */15 * * * *
description = Cette requête détecte les commandes net user, net localgroup, et net group avec le paramètre /add, qui peuvent être utilisées pour ajouter des utilisateurs ou des groupes, ce qui peut indiquer une tentative d’élévation de privilèges.
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","EventCode"]
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="connectix"\
(\
    sourcetype="WinEventLog:Microsoft-Windows-Sysmon/Operational" \
    OR sourcetype="sysmon"\
)EventCode=1

[Installation de services en dehors des répertoires standards]
action.create_alert = 1
action.create_alert.param.template = 672f2ea5c8f5d6b70e077788
action.create_alert.param.title = Installation de services en dehors des répertoires standards
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 30 * * * *
description = Détecte les installations de services en dehors des répertoires système standards, en excluant System32, Program Files, Program Files (x86), et les répertoires de Windows Update.
dispatch.earliest_time = -1h
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","event_type","CommandInvocation_Out_Default_","Image"]
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="connectix" source="WinEventLog:System" EventCode=4697\
| eval is_not_system32 = if(NOT (Service_File_Name LIKE "C:\\Windows\\system32\\*" OR Service_File_Name LIKE "\\SystemRoot\\system32\\*"), 1, 0)\
| eval is_not_program_files = if(NOT (Service_File_Name LIKE "C:\\Program Files\\*" OR Service_File_Name LIKE "\\SystemRoot\\Program Files\\*"), 1, 0)\
| eval is_not_program_files_x86 = if(NOT (Service_File_Name LIKE "C:\\Program Files (x86)\\*" OR Service_File_Name LIKE "\\SystemRoot\\Program Files (x86)\\*"), 1, 0)\
| eval is_not_windows_update = if(NOT (Service_File_Name LIKE "*\\Windows Defender\\Definition Updates\\*" OR Service_File_Name LIKE "C:\\Windows\\SoftwareDistribution\\*" OR Service_File_Name LIKE "C:\\Windows\\System32\\catroot2\\*"), 1, 0)\
| where is_not_system32=1 AND is_not_program_files=1 AND is_not_program_files_x86=1 AND is_not_windows_update=1\
| table ComputerName, Service_Name, Service_File_Name, User, _time

[extraction et modification dinformations didentification via registre]
action.create_alert = 1
action.create_alert.param.template = 6730dd40c8f5d6b70e077fdd
action.create_alert.param.title = extraction et modification dinformations didentification via registre
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = */15 * * * *
description = Cette règle permet de détecter des actions suspectes qui extraient ou modifient des paramètres de sécurité critiques du registre Windows.
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","EventCode"]
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="connectix" \
(\
    sourcetype="WinEventLog:Microsoft-Windows-Sysmon/Operational" \
    OR sourcetype="sysmon"\
) \
(EventCode=1) // EventCode=1 pour la création de processus\
(\
    // Wdigest Key\
    CommandLine="*reg query HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\Wdigest*" \
    OR CommandLine="*reg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\Wdigest /v UseLogonCredential /t REG_DWORD /d 1*"\
    \
    // LSA Protection Key\
    OR CommandLine="*reg query HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa*"\
    OR CommandLine="*reg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa /v RunAsPPL /t REG_DWORD /d 0*"\
\
    // SAM Key\
    OR CommandLine="*reg query HKLM\\SYSTEM\\CurrentControlSet\\Services\\SamSs\\Parameters*"\
    OR CommandLine="*reg save HKLM\\SAM*"\
    OR CommandLine="*reg load HKLM\\SAM*"\
)

[Defense Evasion éviter la détection Powershell]
action.create_alert = 1
action.create_alert.param.template = 672f2c0cc8f5d6b70e077729
action.create_alert.param.title = Defense Evasion éviter la détection Powershell
action.webhook.enable_allowlist = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = */5 * * * *
description = Cette requête permet de surveiller les activités PowerShell suspectes pouvant indiquer des tentatives d'évasion via l'obfuscation ou le contournement des restrictions d'exécution de PowerShell. notamment l'exécution sans profil ou l'utilisation de commandes encodées : Pour dissimuler le contenu des commandes et échapper à la détection.
dispatch.earliest_time = -5m
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","EventCode"]
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix source="WinEventLog:Microsoft-Windows-PowerShell/Operational"\
(EventCode=4104 OR EventCode=4103)\
| search "Invoke-Obfuscation" OR "Bypass" OR "NoProfile" OR "EncodedCommand" OR "-nop"

[Création de tâche planifié suspecte]
action.create_alert = 1
action.create_alert.param.template = 6730c054c8f5d6b70e077f94
action.create_alert.param.title = Création de tâche planifié suspecte
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = 30 * * * *
description = Cette règle détecte la création de tâches planifiées en dehors des heures habituelles de travail.
dispatch.earliest_time = -1h
dispatch.latest_time = now
display.events.fields = ["host","source","sourcetype","event_type","CommandInvocation_Out_Default_","Image"]
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index="connectix" source="Wineventlog:Security" EventCode=4698\
| eval hour=strftime(_time, "%H"), period=if(hour >= 18 AND hour < 22, "Tâche crée entre 18h et 22h", "Tâche crée après 22h")\
| stats count by period, Task_Name, Account_Name, _time

[Detection of Drive-by Compromise via Suspicious Process Creation]
action.create_alert = 1
action.create_alert.param.template = 672fbf06c8f5d6b70e077b03
action.create_alert.param.title = Detection of Drive-by Compromise via Suspicious Process Creation
action.logevent = 0
action.logevent.param.event = Detection of Drive-by Compromise via Suspicious Process Creation
action.logevent.param.index = alerts
action.webhook.enable_allowlist = 0
alert.digest_mode = 0
alert.expires = 24d
alert.suppress = 0
alert.track = 0
alert_condition = search count > 0
counttype = custom
cron_schedule = 45 * * * *
description = Identify potential drive-by download attacks where browsers initiate unexpected processes, possibly indicating exploitation through malicious websites.
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
display.events.fields = ["source","sourcetype"]
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
enableSched = 1
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=connectix sourcetype=WinEventLog:Security OR sourcetype=WinEventLog:Microsoft-Windows-Sysmon/Operational| eval CommandLine=coalesce(CommandLine, ParentCommandLine)| eval CommandLine=lower(CommandLine)| search OriginalFileName IN ("wmic.exe", "powershell.exe", "wbemtool.exe", "wmiprvse.exe", "wmiadap.exe", "scrcons.exe")| stats count by  host, OriginalFileName, ComputerName, CommandLine, ParentCommandLine, Hashes | table *
